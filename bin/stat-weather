#!/usr/bin/perl

use strict;
use warnings;

use HTTP::Tiny;

my $ua = HTTP::Tiny->new;

my $url = 'http://tgftp.nws.noaa.gov/data/observations/metar/decoded/' .
   shift(@ARGV) .
   '.TXT';

my $formatter = shift || 'use Data::Dumper; warn Dumper(shift)';

my $code = eval "sub { \$_ = \$_[0]; $formatter }";

while (1) {
   my $res = $ua->get($url);

   if ($res->{success}) {
      $code->(parse($res->{content}))
   } else {
      warn "$res->{content}\n"
   }

   sleep 600;
}

sub parse {
   my $content = shift;

   my %ret;

   ($ret{temp_f}) = ($content =~ m/Temperature: ([\d\.]+) F/);

   return \%ret
}
