#!/usr/bin/env perl

use 5.22.0;
use warnings;

# TODO: make this work for ssh options
my $host = shift;

if (!@ARGV) {
   system('ssh', $host, <<'SH');
   set -e
   mkdir -p $HOME/code
   if [ ! -d $HOME/code/dotfiles ]; then
      set -e
      timeout 20s git clone --quiet git://github.com/frioux/dotfiles $HOME/code/dotfiles
      cd $HOME/code/dotfiles
      ./install.sh
   fi
   exit 0
SH

   if ($? >> 8) {
      warn "git clone timed out; falling back to rsync\n";

      system('rsync', '-lr', '/home/frew/code/dotfiles/', "$host:/home/frew/code/dotfiles/");

      system('ssh', $host, 'cd /home/frew/code/dotfiles; ./install.sh')
         unless $? >> 8;
   }
}

exec 'ssh', $host, @ARGV
